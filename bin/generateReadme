#! /bin/env php
<?php

require_once __DIR__ . '/../vendor/autoload.php';

use Knp\Snappy\Image;

// variables to dump
$variables = array(
    array(
        1, 2, fopen(__FILE__, 'r'),
        uniqid() => array(
            4,
            array(
                uniqid() => 5, 'foobar'
            ),
            7
        ),
        8 => new stdClass
    ),
    new DateTime
);


// get template
$template = file_get_contents(__DIR__ . '/../resources/template.README.md');


// cli dump
$dumper = Marmotz\Dumper\Dump::factory('cli');

$dump = '';

foreach (array_keys($variables) as $key) {
    $dump .= $dumper->getDump($variables[$key]) . PHP_EOL;
}

$template = str_replace('{{cli-dump}}', $dump, $template);


// html dump
$dumper = Marmotz\Dumper\Dump::factory('apache2');

$dump = '';

foreach (array_keys($variables) as $key) {
    $dump .= $dumper->getDump($variables[$key]) . PHP_EOL;
}

// generate image
$resourcePath = realpath(__DIR__ . '/../resources');
$jsPath       = $resourcePath . '/generateScreenshot.js';
$imagePath    = $resourcePath . '/readme.dump.png';
$tmpPath      = tempnam('/tmp', 'dumper');

if (file_exists($imagePath)) {
    unlink($imagePath);
}

file_put_contents($tmpPath, $dump);

exec("slimerjs $jsPath $tmpPath $imagePath \"400*900\" 1");

// write README.md
file_put_contents(__DIR__ . '/../README.md', $template);