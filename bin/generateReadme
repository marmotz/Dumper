#! /bin/env php
<?php

require_once __DIR__ . '/../vendor/autoload.php';

use Knp\Snappy\Image;

// variables to dump
$variables = array(
    array(
        1, 2, fopen(__FILE__, 'r'),
        uniqid() => array(
            4,
            array(
                uniqid() => 5, 'foobar'
            ),
            7
        ),
        8 => new stdClass
    ),
    new DateTime
);


// get template
$template = file_get_contents(__DIR__ . '/../resources/template.README.md');


// cli dump
$dumper = Marmotz\Dumper\Dump::factory('cli');

$dump = '';

foreach (array_keys($variables) as $key) {
    $dump .= $dumper->getDump($variables[$key]) . PHP_EOL;
}

$template = str_replace('{{cli-dump}}', $dump, $template);


// html dump
$dumper = Marmotz\Dumper\Dump::factory('apache2');

$dump = '';

foreach (array_keys($variables) as $key) {
    $dump .= $dumper->getDump($variables[$key]) . PHP_EOL;
}

// generate image
$imagePath = __DIR__ . '/../resources/readme.dump.jpg';

if (file_exists($imagePath)) {
    unlink($imagePath);
}

$arch = PHP_INT_SIZE === 8 ? 'amd64' : 'i386';

$snappy = new Image(__DIR__ . "/../vendor/google/wkhtmltoimage-$arch/wkhtmltoimage-$arch");
$snappy->setOption('crop-w', 350);
$snappy->generateFromHtml($dump, $imagePath);

// write README.md
file_put_contents(__DIR__ . '/../README.md', $template);